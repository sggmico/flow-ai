# FlowAI 一键迁移方案

> 让开发者可以快速复用 FlowAI 工作流的迁移机制设计

**生成日期**: 2026-01-15
**文档类型**: 设计/规格说明
**状态**: 初稿

---

## 摘要

本方案设计了一套完整的一键迁移机制, 让其他开发者可以快速将 FlowAI 的 Skills 和工作流迁移到自己的项目中. 核心包括:

1. **配置文件** (`flowai.config.yaml`) - 集中管理所有可配置项
2. **环境变量** (`.flowai.env`) - 敏感信息和路径配置
3. **迁移脚本** (`scripts/migrate.py`) - 自动化占位符替换
4. **配置检查器** - 验证配置完整性

---

## 问题分析

### 当前痛点

1. **硬编码路径**: 如 `/Users/sggmico/ws/cc/build-blog/{year}/` 等个人路径
2. **GitHub 配置**: `LearnFlowAI/starter` 等组织/仓库信息固定
3. **隐式配置**: 部分配置散落在各 SKILL.md 中, 不易发现
4. **无迁移指引**: 新用户不知道需要修改哪些内容

### 需要配置的项目

| 配置项 | 类型 | 示例值 | 所在文件 |
|--------|------|--------|----------|
| 发布目录 | 路径 | `/Users/sggmico/ws/cc/build-blog/{year}/` | post_master |
| GitHub Org | 字符串 | `LearnFlowAI` | code_sync-issue |
| GitHub Repo | 字符串 | `starter` | code_sync-issue |
| GitHub Project ID | 数字 | `1` | code_sync-issue |
| 评审输出目录 | 路径 | `docs/cr_local/` | code_master |
| 草稿目录 | 路径 | `docs/post_local/` | fs_detect |

---

## 设计方案

### 架构概览

```
flowai.config.yaml          <- 主配置文件 (必须)
.flowai.env                  <- 环境变量 (敏感信息, 可选)
scripts/migrate.py           <- 迁移脚本
skills/                      <- 技能目录 (使用占位符)
    ├── post_master/
    │   └── SKILL.md         <- 引用 ${PUBLISH_DIR}
    ├── code_sync-issue/
    │   └── SKILL.md         <- 引用 ${GITHUB_ORG}, ${GITHUB_REPO}
    └── ...
```

### 配置优先级

```
环境变量 > .flowai.env > flowai.config.yaml > 默认值
```

---

## 详细设计

### 1. 配置文件格式 (flowai.config.yaml)

```yaml
# FlowAI 配置文件
# 复制此文件并填入您的实际值

version: "1.0"

# ========== 必须配置 ==========
paths:
  # 文章发布目录 (支持 {year} 占位符)
  publish_dir: "/path/to/your/blog/{year}/"

  # 评审文档输出目录 (相对于项目根)
  cr_output_dir: "docs/cr_local/"

  # 草稿目录 (相对于项目根, 按优先级)
  draft_dirs:
    - "docs/post_local/"
    - "docs/post/"
    - "post/"

github:
  # GitHub 组织名
  org: "YourOrg"

  # GitHub 仓库名
  repo: "your-repo"

  # GitHub Projects ID
  project_id: 1

# ========== 可选配置 ==========
defaults:
  # Claude 模型选择: haiku | sonnet | opus
  model: "sonnet"

  # 文章风格: tutorial | guide | reference
  article_style: "tutorial"

  # 技术难度: beginner | intermediate | advanced
  article_level: "intermediate"

  # 文章长度: short | medium | long
  article_length: "medium"

  # UI/UX 默认技术栈
  ui_stack: "html-tailwind"

git_worktree:
  # Worktree 路径模式 (支持 {project}, {branch} 占位符)
  path_pattern: "../{project}-{branch}"

  # 分支前缀
  branch_prefix: "dev/"

  # 自动共享的文件
  shared_files:
    - ".env"
    - ".env.local"

# 敏感文件拦截规则 (code_ci)
sensitive_patterns:
  - ".env"
  - ".env.*"
  - "*.key"
  - "*.pem"
  - "*secret*"
  - "*password*"
  - "*token*"
```

### 2. 环境变量文件 (.flowai.env.example)

```bash
# FlowAI 环境变量配置
# 复制为 .flowai.env 并填入实际值
# 此文件应加入 .gitignore

# ========== 必须配置 ==========

# 文章发布目录 (支持 {year} 占位符)
FLOWAI_PUBLISH_DIR="/path/to/your/blog/{year}/"

# GitHub 配置
FLOWAI_GITHUB_ORG="YourOrg"
FLOWAI_GITHUB_REPO="your-repo"
FLOWAI_GITHUB_PROJECT_ID="1"

# ========== 可选配置 ==========

# 评审输出目录
FLOWAI_CR_OUTPUT_DIR="docs/cr_local/"

# 默认模型
FLOWAI_DEFAULT_MODEL="sonnet"

# UI/UX 默认技术栈
FLOWAI_UI_STACK="html-tailwind"
```

### 3. 占位符规范

在 SKILL.md 中使用以下占位符格式:

| 占位符 | 说明 | 示例 |
|--------|------|------|
| `${PUBLISH_DIR}` | 发布目录 | `/Users/xxx/blog/{year}/` |
| `${GITHUB_ORG}` | GitHub 组织 | `LearnFlowAI` |
| `${GITHUB_REPO}` | GitHub 仓库 | `starter` |
| `${GITHUB_PROJECT_ID}` | Project ID | `1` |
| `${CR_OUTPUT_DIR}` | 评审输出目录 | `docs/cr_local/` |
| `${DEFAULT_MODEL}` | 默认模型 | `sonnet` |
| `{year}` | 动态年份 | `2026` |
| `{project}` | 项目名 | `flow-ai` |
| `{branch}` | 分支名 | `feature-xxx` |

### 4. 迁移脚本设计 (scripts/migrate.py)

```python
#!/usr/bin/env python3
"""
FlowAI 一键迁移脚本

用法:
  python3 scripts/migrate.py init          # 初始化配置文件
  python3 scripts/migrate.py check         # 检查配置完整性
  python3 scripts/migrate.py apply         # 应用配置到 Skills
  python3 scripts/migrate.py show          # 显示当前配置
  python3 scripts/migrate.py reset         # 重置为占位符
"""

import argparse
import yaml
import os
import re
from pathlib import Path
from typing import Dict, Any

class FlowAIMigrator:
    """FlowAI 迁移管理器"""

    CONFIG_FILE = "flowai.config.yaml"
    ENV_FILE = ".flowai.env"
    SKILLS_DIR = "skills"

    # 占位符映射
    PLACEHOLDER_MAP = {
        "${PUBLISH_DIR}": "paths.publish_dir",
        "${GITHUB_ORG}": "github.org",
        "${GITHUB_REPO}": "github.repo",
        "${GITHUB_PROJECT_ID}": "github.project_id",
        "${CR_OUTPUT_DIR}": "paths.cr_output_dir",
        "${DEFAULT_MODEL}": "defaults.model",
    }

    # 需要配置的必填项
    REQUIRED_CONFIGS = [
        "paths.publish_dir",
        "github.org",
        "github.repo",
        "github.project_id",
    ]

    def __init__(self, project_root: Path):
        self.root = project_root
        self.config: Dict[str, Any] = {}

    def init(self) -> None:
        """初始化配置文件"""
        config_path = self.root / self.CONFIG_FILE
        env_path = self.root / f"{self.ENV_FILE}.example"

        if config_path.exists():
            print(f"配置文件已存在: {config_path}")
            return

        # 生成默认配置
        default_config = self._get_default_config()

        with open(config_path, 'w', encoding='utf-8') as f:
            yaml.dump(default_config, f, allow_unicode=True, default_flow_style=False)

        print(f"已创建配置文件: {config_path}")
        print(f"请编辑配置文件并填入实际值")

    def check(self) -> bool:
        """检查配置完整性"""
        self._load_config()

        missing = []
        for key in self.REQUIRED_CONFIGS:
            value = self._get_nested(self.config, key)
            if not value or value.startswith("${") or value.startswith("/path/to"):
                missing.append(key)

        if missing:
            print("以下配置项需要填写:")
            for key in missing:
                print(f"  - {key}")
            return False

        print("配置检查通过!")
        self._show_config()
        return True

    def apply(self) -> None:
        """应用配置到 Skills"""
        if not self.check():
            print("请先完成配置")
            return

        skills_dir = self.root / self.SKILLS_DIR
        if not skills_dir.exists():
            print(f"Skills 目录不存在: {skills_dir}")
            return

        # 遍历所有 SKILL.md 文件
        for skill_file in skills_dir.rglob("SKILL.md"):
            self._apply_to_file(skill_file)

        print("配置已应用到所有 Skills")

    def show(self) -> None:
        """显示当前配置"""
        self._load_config()
        self._show_config()

    def reset(self) -> None:
        """重置为占位符"""
        skills_dir = self.root / self.SKILLS_DIR

        for skill_file in skills_dir.rglob("SKILL.md"):
            self._reset_file(skill_file)

        print("已重置所有 Skills 为占位符")

    def _load_config(self) -> None:
        """加载配置"""
        config_path = self.root / self.CONFIG_FILE

        if config_path.exists():
            with open(config_path, 'r', encoding='utf-8') as f:
                self.config = yaml.safe_load(f) or {}

        # 环境变量覆盖
        self._load_env_overrides()

    def _load_env_overrides(self) -> None:
        """加载环境变量覆盖"""
        env_map = {
            "FLOWAI_PUBLISH_DIR": "paths.publish_dir",
            "FLOWAI_GITHUB_ORG": "github.org",
            "FLOWAI_GITHUB_REPO": "github.repo",
            "FLOWAI_GITHUB_PROJECT_ID": "github.project_id",
            "FLOWAI_CR_OUTPUT_DIR": "paths.cr_output_dir",
            "FLOWAI_DEFAULT_MODEL": "defaults.model",
        }

        # 先加载 .flowai.env 文件
        env_file = self.root / self.ENV_FILE
        if env_file.exists():
            self._parse_env_file(env_file)

        # 然后检查系统环境变量
        for env_key, config_key in env_map.items():
            value = os.environ.get(env_key)
            if value:
                self._set_nested(self.config, config_key, value)

    def _parse_env_file(self, path: Path) -> None:
        """解析 .env 文件"""
        with open(path, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    os.environ[key.strip()] = value.strip().strip('"\'')

    def _get_nested(self, d: dict, key: str) -> Any:
        """获取嵌套键值"""
        keys = key.split('.')
        for k in keys:
            if isinstance(d, dict) and k in d:
                d = d[k]
            else:
                return None
        return d

    def _set_nested(self, d: dict, key: str, value: Any) -> None:
        """设置嵌套键值"""
        keys = key.split('.')
        for k in keys[:-1]:
            d = d.setdefault(k, {})
        d[keys[-1]] = value

    def _get_default_config(self) -> dict:
        """获取默认配置模板"""
        return {
            "version": "1.0",
            "paths": {
                "publish_dir": "/path/to/your/blog/{year}/",
                "cr_output_dir": "docs/cr_local/",
                "draft_dirs": [
                    "docs/post_local/",
                    "docs/post/",
                    "post/",
                ],
            },
            "github": {
                "org": "${GITHUB_ORG}",
                "repo": "${GITHUB_REPO}",
                "project_id": 1,
            },
            "defaults": {
                "model": "sonnet",
                "article_style": "tutorial",
                "article_level": "intermediate",
                "article_length": "medium",
                "ui_stack": "html-tailwind",
            },
        }

    def _show_config(self) -> None:
        """显示配置"""
        print("\n当前配置:")
        print("-" * 40)
        for key in self.REQUIRED_CONFIGS:
            value = self._get_nested(self.config, key)
            status = "✓" if value and not str(value).startswith("${") else "✗"
            print(f"  {status} {key}: {value}")
        print("-" * 40)

    def _apply_to_file(self, path: Path) -> None:
        """应用配置到单个文件"""
        with open(path, 'r', encoding='utf-8') as f:
            content = f.read()

        modified = False
        for placeholder, config_key in self.PLACEHOLDER_MAP.items():
            value = self._get_nested(self.config, config_key)
            if value and placeholder in content:
                content = content.replace(placeholder, str(value))
                modified = True

        if modified:
            with open(path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"  已更新: {path.relative_to(self.root)}")

    def _reset_file(self, path: Path) -> None:
        """重置文件为占位符"""
        # 此方法需要记录原始值才能反向替换
        # 简化实现: 提示用户从 git 恢复
        print(f"  提示: 使用 git checkout {path.relative_to(self.root)} 恢复")


def main():
    parser = argparse.ArgumentParser(description="FlowAI 一键迁移工具")
    parser.add_argument("command", choices=["init", "check", "apply", "show", "reset"])
    parser.add_argument("--root", default=".", help="项目根目录")

    args = parser.parse_args()

    migrator = FlowAIMigrator(Path(args.root).resolve())

    commands = {
        "init": migrator.init,
        "check": migrator.check,
        "apply": migrator.apply,
        "show": migrator.show,
        "reset": migrator.reset,
    }

    commands[args.command]()


if __name__ == "__main__":
    main()
```

---

## 迁移流程

### 快速开始 (3 步)

```bash
# 1. 克隆仓库
git clone https://github.com/YourOrg/flow-ai.git
cd flow-ai

# 2. 初始化并编辑配置
python3 scripts/migrate.py init
vim flowai.config.yaml  # 填入您的实际配置

# 3. 应用配置
python3 scripts/migrate.py apply
```

### 详细步骤

#### Step 1: 初始化配置

```bash
python3 scripts/migrate.py init
```

输出:
```
已创建配置文件: flowai.config.yaml
请编辑配置文件并填入实际值
```

#### Step 2: 编辑配置文件

打开 `flowai.config.yaml`, 填入您的实际值:

```yaml
paths:
  publish_dir: "/Users/yourname/projects/my-blog/{year}/"

github:
  org: "MyOrg"
  repo: "my-project"
  project_id: 2
```

#### Step 3: 检查配置

```bash
python3 scripts/migrate.py check
```

输出:
```
当前配置:
----------------------------------------
  ✓ paths.publish_dir: /Users/yourname/projects/my-blog/{year}/
  ✓ github.org: MyOrg
  ✓ github.repo: my-project
  ✓ github.project_id: 2
----------------------------------------
配置检查通过!
```

#### Step 4: 应用配置

```bash
python3 scripts/migrate.py apply
```

输出:
```
  已更新: skills/post_master/SKILL.md
  已更新: skills/code_sync-issue/SKILL.md
配置已应用到所有 Skills
```

---

## 配置项完整清单

### 必填配置

| 配置键 | 环境变量 | 说明 | 示例 |
|--------|----------|------|------|
| `paths.publish_dir` | `FLOWAI_PUBLISH_DIR` | 文章发布目录 | `/path/to/blog/{year}/` |
| `github.org` | `FLOWAI_GITHUB_ORG` | GitHub 组织名 | `MyOrg` |
| `github.repo` | `FLOWAI_GITHUB_REPO` | GitHub 仓库名 | `my-project` |
| `github.project_id` | `FLOWAI_GITHUB_PROJECT_ID` | Project ID | `1` |

### 可选配置

| 配置键 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| `paths.cr_output_dir` | `FLOWAI_CR_OUTPUT_DIR` | `docs/cr_local/` | 评审输出目录 |
| `defaults.model` | `FLOWAI_DEFAULT_MODEL` | `sonnet` | Claude 模型 |
| `defaults.article_style` | - | `tutorial` | 文章风格 |
| `defaults.article_level` | - | `intermediate` | 技术难度 |
| `defaults.article_length` | - | `medium` | 文章长度 |
| `defaults.ui_stack` | `FLOWAI_UI_STACK` | `html-tailwind` | UI 技术栈 |

### 自动检测 (无需配置)

| 配置项 | 检测方式 | 说明 |
|--------|----------|------|
| 项目根目录 | 查找 `.git`, `package.json` 等 | 自动向上查找 |
| 草稿目录 | 按优先级检测 | `docs/post_local/` > `docs/post/` > `post/` |
| 文章 ID | 扫描现有文件 | 自动递增 001-999 |
| 年份占位符 | 系统时间 | 自动替换 `{year}` |

---

## 文件清单

迁移完成后, 仓库应包含以下新增文件:

```
flow-ai/
├── flowai.config.yaml       # 主配置文件 (已填写)
├── flowai.config.example    # 配置模板 (供参考)
├── .flowai.env.example      # 环境变量模板
├── .flowai.env              # 实际环境变量 (gitignore)
├── scripts/
│   └── migrate.py           # 迁移脚本
└── docs/
    └── 001_一键迁移方案.md   # 本文档
```

### .gitignore 添加项

```gitignore
# FlowAI 本地配置
.flowai.env
flowai.config.yaml
```

---

## 验证清单

迁移完成后, 请验证以下功能:

- [ ] `python3 scripts/migrate.py check` 输出全部 ✓
- [ ] post_master 发布目录正确
- [ ] code_sync-issue GitHub 配置正确
- [ ] code_cr 评审文档输出到正确目录
- [ ] fs_detect 草稿目录检测正常

---

## 回滚方案

如需恢复原始占位符:

```bash
# 方式 1: 使用 git 恢复
git checkout skills/

# 方式 2: 使用迁移脚本
python3 scripts/migrate.py reset
```

---

## 风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|----------|
| 配置文件泄露敏感信息 | 中 | `.flowai.env` 加入 gitignore |
| 占位符替换错误 | 低 | 提供 check 命令验证 |
| 依赖路径不存在 | 低 | 脚本自动验证路径有效性 |

---

## 下一步

1. **实现迁移脚本**: 创建 `scripts/migrate.py`
2. **更新 Skills**: 将硬编码值替换为占位符
3. **创建模板文件**: `flowai.config.example`, `.flowai.env.example`
4. **更新 README**: 添加迁移指南
5. **编写测试**: 验证迁移流程

---

**文档作者**: Claude
**更新日期**: 2026-01-15
